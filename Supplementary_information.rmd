---
title: "Supplementary Information"
author: "Lujun Zhang and Jun Chen"
date: "2023-09-24"
output:
  html_document:
    number_sections: true
---

# Setups and Introduction

## Required Packages

- `doParallel`, `foreach`, `doRNG`, `Matrix`, `matrixStats`, `GUniFrac`, `tidyverse`, `data.table`, `peakRAM`, `ggpubr` from CRAN.
- `DESeq2` from Bioconductor.
- `ideas` from [https://github.com/Sun-lab/ideas](https://github.com/Sun-lab/ideas).

## Required Dataset

- **File:** "supp_info_anal/n12_12_d1.3_c375_vFALSE_0811_b1.RData"
    +  The files "supp_info_anal/mem_results0827.RData," "supp_info_anal/nperm_results0827.RData," "supp_info_anal/rarefy_results0827.RData," and "supp_info_anal/time_results0821.RData" are saved cache to accelerate the rendering of the markdown file.
- This dataset was generated in the "Generate Simulation Datasets" step in the "Parametric_simulation.rmd".
- It contains 12 cases and 12 controls, each with 375 cell replicates.
- The read depths of each cell replicate are well-balanced.
- The dataset comprises a total of 8,000 genes.
- **Signal density:** 15%, with differences in mean, variance, and mean+variance (each at 5%).

## Objectives for this file (Supplementary Information)

- Determine the number of permutations required for DiSC.
- Compare the computational time of different methods.
- Evaluate memory usage by DiSC.
- Examine the impact of dropping a proportion of insufficiently sequenced cells during the rarefaction step on the results.


```{r setup, warning = FALSE, message=FALSE}
library(DESeq2)
# library(ideas)
library(tidyverse)
library(GUniFrac)
library(matrixStats)
library(knitr)
library(kableExtra)
library(peakRAM)
library(data.table)
library(ggpubr)

knitr::opts_chunk$set(echo = TRUE)
set.seed(seed = 123456)

# rm(list = ls())
source("source_code/DiSC.R")
load("supp_info_anal/n12_12_d1.3_c375_vFALSE_0811_b1.RData")
dat_list[["meta_ind"]]$phenotype <- as.factor(dat_list[["meta_ind"]]$phenotype)
dat_list[["meta_cell"]]$phenotype <- as.factor(dat_list[["meta_cell"]]$phenotype)
```

# Description of the Data Set

```{r dat_list}
str(dat_list)
attach(dat_list)
ngene = nrow(count_matrix)
ngene
nsamp = ncol(count_matrix)
nsamp
colSums(count_matrix)[1:10]
meta_cell$cell_rd[1:10]
table(meta_cell$individual)
table(meta_ind$phenotype)
sparsity = rowSums(count_matrix == 0)/ngene
summary(sparsity)
detach(dat_list)
```

# Number of permutations

If adjusted p-values (FDR) are of primary interest, which is usually the case, setting `perm.no` = 99 will suffice and can accelarate the calculations while reducing memory usage.

```{r N.perm, results='asis'}
attach(dat_list)

fp <- "supp_info_anal/nperm_results0827.RData"
if(file.exists(fp)){
  load(fp)
} else {
  rarefy_mat <- count_matrix %>% t() %>% 
    GUniFrac::Rarefy(.) %>%
    magrittr::extract2(., "otu.tab.rff") %>%
    t()
  
  #default
  obj1 <- DiSC(ct.mat = rarefy_mat,
               cell.ind = meta_cell,
               metadata = meta_ind,
               outcome = "phenotype", covariates = "RIN",
               cell.id = "cell_id",
               individual.id = "individual", 
               perm.no = 999, verbose = FALSE) 
  
  obj2 <- DiSC(ct.mat = rarefy_mat,
               cell.ind = meta_cell,
               metadata = meta_ind,
               outcome = "phenotype", covariates = "RIN",
               cell.id = "cell_id",
               individual.id = "individual", 
               perm.no = 499, verbose = FALSE) 
  
  #for fdr calculation
  obj3 <- DiSC(ct.mat = rarefy_mat,
               cell.ind = meta_cell,
               metadata = meta_ind,
               outcome = "phenotype", covariates = "RIN",
               cell.id = "cell_id",
               individual.id = "individual", 
               perm.no = 99, verbose = FALSE)
  
  obj4 <- DiSC(ct.mat = rarefy_mat,
               cell.ind = meta_cell,
               metadata = meta_ind,
               outcome = "phenotype", covariates = "RIN",
               cell.id = "cell_id",
               individual.id = "individual", 
               perm.no = 49, verbose = FALSE) 
  save(obj1, obj2, obj3, obj4, file = fp)
}


gene_stra <- unlist(gene_index) %>% 
  sort() %>% names() %>% str_extract(pattern = "\\w+_index")
gene_stra[gene_index$mean_index[1:10]]
meths = c("p.raw", "p.adj.fdr")

for(me in meths){
  p_cat <- cut(obj1[[me]], 
               breaks = c(-1, 0.001, 0.01, 0.05, 0.10, +Inf),
               labels = c("<= 0.001", "0.001 - 0.01", 
                          "0.01 - 0.05", "0.05 - 0.10",
                          "> 0.10"))
  N_perm_results <-
    tibble("P value category" = p_cat, "Gene stratum" = gene_stra,
           "N.perm = 999" = obj1[[me]], "N.perm = 499" = obj2[[me]],
           "N.perm = 99" = obj3[[me]],  "N.perm = 49" = obj4[[me]])
  flag <- str_remove(str_extract(me, "\\.\\w+$"), "\\.")
  N_perm_results %>% group_by(`P value category`, `Gene stratum`) %>% 
    slice_head(n = 1) %>%
    kbl(digits = 4, 
        caption = str_glue("Influence of the number of permutations in P values ({flag})")) %>% 
    kable_classic(full_width = F, html_font = "Cambria") %>%
    print()
}

detach(dat_list)
```

# Computational time

-  Examining computational time over three factors:
    +  By the number of genes
    +  By the number of cells
    +  By the number of samples/individuals

##  Calculations

```{r computational time examination, message = FALSE}
fp <- "supp_info_anal/time_results0821.RData"
if(file.exists(fp))
  load(fp) else
  {
    setups <- function(dat_list, ngene = 700, ncell = 100, nsample = 5){
      count_matrix <- dat_list$count_matrix
      gene_index <- dat_list$gene_index
      meta_ind <- dat_list$meta_ind
      meta_cell <- dat_list$meta_cell
      
      count_matrix <- count_matrix[1:ngene,]
      gene_index <- lapply(gene_index, function(gs) gs[gs <= ngene])
      meta_cell$cell_rd <- colSums(count_matrix)
      
      meta_cell <- meta_cell %>% group_by(individual) %>% slice_head(n=ncell)
      count_matrix <- count_matrix[, meta_cell$cell_id]
      
      meta_ind <- meta_ind %>% group_by(phenotype) %>% slice_head(n=nsample)
      meta_cell <- meta_cell %>% filter(individual %in% meta_ind$individual)
      count_matrix <- count_matrix[, meta_cell$cell_id]
      
      return(list(count_matrix = count_matrix, gene_index = gene_index,
                  meta_ind = meta_ind, meta_cell = meta_cell))
    }
    ideas_wrapper <- function(dat_list_temp){
      with(dat_list_temp, suppressMessages({
        dist1 <- suppressWarnings(
          ideas_dist(count_input = count_matrix, 
                     meta_cell = meta_cell, meta_ind = meta_ind, 
                     var_per_cell = "cell_rd", var2test = "phenotype", 
                     var2test_type = "binary",
                     d_metric = "Was", fit_method = "nb")
        )
        ideas_pval_raw <- permanova(dist_array = dist1, meta_ind = meta_ind, 
                                    var2test = "phenotype", var2adjust = "RIN", 
                                    var2test_type = "binary", n_perm=999)
      }))
    }
    
    disc_wrapper <- function(dat_list_temp){
      with(dat_list_temp, suppressMessages({
        rarefy_mat <- count_matrix %>% t() %>% 
          GUniFrac::Rarefy(.) %>%
          magrittr::extract2(., "otu.tab.rff") %>%
          t()
        #default
        obj1 <- DiSC(ct.mat = rarefy_mat,
                     cell.ind = meta_cell,
                     metadata = meta_ind,
                     outcome = "phenotype", covariates = "RIN",
                     cell.id = "cell_id",
                     individual.id = "individual", 
                     perm.no = 999, verbose = FALSE)
      }))
    }
    
    deseq_wrapper<- function(dat_list_temp){
      with(dat_list_temp, suppressMessages({
        # prepossing
        count_matrix_bulk = matrix(NA, nrow = nrow(count_matrix), 
                                   ncol = nrow(meta_ind))
        rownames(count_matrix_bulk) = rownames(count_matrix)
        colnames(count_matrix_bulk) = meta_ind[["individual"]]
        if(sum(meta_cell[["cell_id"]] != colnames(count_matrix))==0)
          for (i_ind in 1:length(meta_ind[["individual"]])) {
            cur_ind   = meta_ind[["individual"]][i_ind]
            cur_ind_m = count_matrix[, meta_cell[["individual"]] == cur_ind] 
            count_matrix_bulk[, i_ind] = rowSums(cur_ind_m, na.rm = TRUE)
          }else
            stop("meta_cell$cell_id and colnames(count_matrix) dont match")
        
        dds <- DESeq2::DESeqDataSetFromMatrix(countData = count_matrix_bulk,
                                              colData = meta_ind,
                                              design = ~ RIN + phenotype)
        dds <- DESeq2::DESeq(dds, quiet = TRUE)
        deseq_pval_adj <- DESeq2::results(dds, name = "phenotype_1_vs_0", 
                                          independentFiltering=FALSE,
                                          cooksCutoff=FALSE)$padj
        deseq_pval_raw <- DESeq2::results(dds, name = "phenotype_1_vs_0",
                                          independentFiltering=FALSE,
                                          cooksCutoff=FALSE)$pvalue
      }))
    }
    
    boot = 5
    results <- data.frame(expr = character(), time = numeric(),
                          ngene = numeric(), ncell = numeric(),
                          nsample = numeric())
    NGENES <- c(700, 800, 900, 1000)
    NCELL <- c(100, 150, 200, 250)
    NSAMPLE <- c(5, 6, 7, 8)
    parameters <- bind_rows(
      data.frame(nc = NCELL[1], ns = NSAMPLE[1], ng = NGENES),
      data.frame(nc = NCELL[1], ns = NSAMPLE, ng = NGENES[1]),
      data.frame(nc = NCELL, ns = NSAMPLE[1], ng = NGENES[1])
    ) %>% distinct(.keep_all = TRUE)
    
    
    for(pa in 1:nrow(parameters)){
      nc = parameters[pa, "nc"]
      ns = parameters[pa, "ns"]
      ng = parameters[pa, "ng"]
      dat_list_temp <- setups(dat_list, ngene = ng, ncell = nc, nsample = ns)
      res <- microbenchmark::microbenchmark(disc_wrapper(dat_list_temp),
                                            ideas_wrapper(dat_list_temp),
                                            deseq_wrapper(dat_list_temp),
                                            times = boot)
      res$ngene = rep(ng, length = boot*3)
      res$ncell = rep(nc, length = boot*3)
      res$nsample = rep(ns, length = boot*3)
      results <- bind_rows(results, as.data.frame(res))
      # run the disc and deseq a few more times to get more accurate estimates
      res <- microbenchmark::microbenchmark(disc_wrapper(dat_list_temp),
                                            deseq_wrapper(dat_list_temp),
                                            times = boot*9)
      res$ngene = rep(ng, length = boot*2*9)
      res$ncell = rep(nc, length = boot*2*9)
      res$nsample = rep(ns, length = boot*2*9)
      results <- bind_rows(results, as.data.frame(res))
    }
    
    #canonical case with ~8000 genes and ~24 samples
    res_c <- microbenchmark::microbenchmark(disc_wrapper(dat_list), times = 5)
    
    save(results, parameters, setups, disc_wrapper, res_c,
         ideas_wrapper, deseq_wrapper, NGENES, NCELL, NSAMPLE,
         file = fp)
  }
meths = c("DiSC", "IDEAS", "DESeq2")
results <- results %>%
  mutate(time = time/1e9) %>%
  dplyr::rename(method = "expr") %>%
  mutate(method = fct_recode(method, DiSC = "disc_wrapper(dat_list_temp)",
                             DESeq2 = "deseq_wrapper(dat_list_temp)",
                             IDEAS = "ideas_wrapper(dat_list_temp)")) %>%
  mutate(method = fct_relevel(method, meths))
```

##  Results

```{r computational time results, fig.width=6, fig.height=3}
#canonical case with 8000 genes and 24 samples
res_c$time <- res_c$time/1e9
mean(res_c$time) #canonical case with 8000 genes and 24 samples, in seconds

fig1 <- results %>% 
  filter(ngene == NGENES[1], ncell == NCELL[1]) %>%
  ggplot(aes(x = nsample, y= time, color = method)) + 
  geom_point(size=0.3) + 
  geom_smooth(method = "lm", formula = y ~ x, se = TRUE, linewidth = 0.3) +
  xlab("Sample Sizes") + ylab("Time / s") + 
  scale_y_log10(limits = c(1, 150)) +
  scale_color_brewer(palette = "Set1", name = "Method") +
  theme_bw()
fig2 <- results %>% 
  filter(nsample == NSAMPLE[1], ncell == NCELL[1]) %>%
  ggplot(aes(x = ngene, y= time, color = method)) + 
  geom_point(size=0.3) + 
  geom_smooth(method = "lm", formula = y ~ x, se = TRUE, linewidth = 0.3) +
  xlab("Number of genes") + ylab("Time / s") +
  scale_y_log10(limits = c(1, 150)) +
  scale_color_brewer(palette = "Set1", name = "Method") +
  theme_bw()
fig3 <- results %>% 
  filter(nsample == NSAMPLE[1], ngene == NGENES[1]) %>%
  ggplot(aes(x = ncell, y= time, color = method)) + 
  geom_point(size=0.3) + 
  geom_smooth(method = "lm", formula = y ~ x, se = TRUE, linewidth = 0.3) +
  xlab("Number of cells") + ylab("Time / s") +
  scale_y_log10(limits = c(1, 150)) +
  scale_color_brewer(palette = "Set1", name = "Method") +
  theme_bw()

time_fig <- 
  ggarrange(fig1, fig2, fig3, ncol = 3, labels = c("(a)", "(b)", "(c)"), 
            legend = "bottom", common.legend = TRUE,
            font.label = list(size = 12, color = "black", 
                              face = "plain", family = NULL))
time_fig
ggsave(filename = "results/comp_time.jpeg", time_fig, 
       width = 6, height = 3)
ggsave(filename = "results/comp_time.pdf", time_fig, 
       width = 6, height = 3)
```

## Memory usage

-  Peak memory usage may vary between runs due to autonomous garbage collection in R.

```{r memory, results='asis'}
attach(dat_list)
#default
fp <- "supp_info_anal/mem_results0827.RData"
if(file.exists(fp))
{
  load(fp)
} else {
  mem_df <- peakRAM({
    rarefy_mat <- count_matrix %>% t() %>% 
      GUniFrac::Rarefy(.) %>%
      magrittr::extract2(., "otu.tab.rff") %>%
      t()
  }, {# default
    obj1 <- DiSC(ct.mat = rarefy_mat,
                 cell.ind = meta_cell,
                 metadata = meta_ind,
                 outcome = "phenotype", covariates = "RIN",
                 cell.id = "cell_id",
                 individual.id = "individual", 
                 perm.no = 999, verbose = FALSE) 
  }, {# for FDR calculation
    obj3 <- DiSC(ct.mat = rarefy_mat,
                 cell.ind = meta_cell,
                 metadata = meta_ind,
                 outcome = "phenotype", covariates = "RIN",
                 cell.id = "cell_id",
                 individual.id = "individual", 
                 perm.no = 99, verbose = FALSE) 
  })
  save(mem_df, file = fp)
}


mem_df$Function_Call <- c("rarefaction", "N.perm = 999" , "N.perm = 99")
mem_df %>% 
  kbl(digits = 5, 
      caption = str_glue("Peak momory usage")) %>% 
  kable_classic(full_width = F, html_font = "Cambria") %>%
  print()
detach(dat_list)
```

# Robustness of Discarding Insufficiently Sequenced Samples

```{r}
disc_wrapper <- function(dat_list_temp, rarefy = TRUE){
  count_matrix <- dat_list_temp$count_matrix
  meta_ind <- dat_list_temp$meta_ind
  meta_cell <- dat_list_temp$meta_cell
  gene_index <- dat_list_temp$gene_index
  
  if(rarefy){
    rarefy_mat <- count_matrix %>% t() %>% 
      GUniFrac::Rarefy(.) %>%
      magrittr::extract2(., "otu.tab.rff") %>%
      t()
    obj1 <- 
      DiSC(ct.mat = rarefy_mat, cell.ind = meta_cell,
           metadata = meta_ind, outcome = "phenotype", covariates = "RIN",
           cell.id = "cell_id", individual.id = "individual", 
           perm.no = 999, verbose = FALSE)
  } else {
    obj1 <- 
      DiSC(ct.mat = count_matrix, cell.ind = meta_cell,
           metadata = meta_ind, outcome = "phenotype", covariates = "RIN",
           cell.id = "cell_id", individual.id = "individual", 
           perm.no = 999, verbose = FALSE)
  }
  
  return(obj1)
}
setups <- function(dat_list, discard = NULL){
  count_matrix <- dat_list$count_matrix
  gene_index <- dat_list$gene_index
  meta_ind <- dat_list$meta_ind
  meta_cell <- dat_list$meta_cell
  
  if(!is.null(discard)){
    depth = round(quantile(meta_cell$cell_rd, probs = discard))
    flag = which(meta_cell$cell_rd >= depth)
    meta_cell <- meta_cell[flag, ]
    count_matrix <- count_matrix[, meta_cell$cell_id]
  }
  
  return(list(count_matrix = count_matrix, gene_index = gene_index,
              meta_ind = meta_ind, meta_cell = meta_cell))
}
settings <- c(
  "discard = NULL; rarefy = TRUE",
  "discard = NULL; rarefy = FALSE",
  "discard = 0.05; rarefy = TRUE",
  "discard = 0.10; rarefy = TRUE",
  "discard = 0.15; rarefy = TRUE",
  "discard = 0.20; rarefy = TRUE"
)
results_raw <- results_adj <-
  matrix(NA_real_, nrow = nrow(dat_list$count_matrix),
         ncol = length(settings), 
         dimnames = list(rownames(dat_list$count_matrix),
                         settings))
gene_stra <- unlist(dat_list$gene_index) %>% 
  sort() %>% names() %>% str_extract(pattern = "\\w+_index")
gene_stra[dat_list$gene_index$mean_index[1:10]] #mean_index

fp <- "supp_info_anal/rarefy_results0827.RData" 
if(file.exists(fp)){
  load(fp)
} else {
  for(se in settings){
    eval(parse(text=se))
    dat_list_temp <- setups(dat_list = dat_list, discard = discard)
    print(dim(dat_list_temp$count_matrix))
    obj <- disc_wrapper(dat_list_temp, rarefy = rarefy)
    results_adj[, se] <- obj$p.adj.fdr
    results_raw[, se] <- obj$p.raw
  }
  save(results_raw, results_adj, settings, 
       file = fp)
}
```



```{r, fig.width=8, fig.height=3}
results_raw <- as_tibble(results_raw) %>%
  dplyr::rename(keep100 = "discard = NULL; rarefy = TRUE",
                no_rarefy = "discard = NULL; rarefy = FALSE",
                keep95 = "discard = 0.05; rarefy = TRUE",
                keep90 = "discard = 0.10; rarefy = TRUE",
                keep85 = "discard = 0.15; rarefy = TRUE",
                keep80 = "discard = 0.20; rarefy = TRUE") %>%
  mutate(`P value category` = cut(keep100, breaks = c(-1, 0.001, 0.01, 0.05, 0.10, +Inf),
                                  labels = c("<= 0.001", "0.001 - 0.01", "0.01 - 0.05", 
                                             "0.05 - 0.10", "> 0.10")),
         `Gene stratum` = gene_stra) 
results_raw %>% 
  group_by(`P value category`, `Gene stratum`) %>% 
  slice_head(n = 1) %>%
  select(-no_rarefy) %>% 
  kbl(digits = 3, 
      caption = "Influence of discarding insufficiently sequenced samples in raw P values") %>% 
  kable_classic(full_width = F, html_font = "Cambria")
fig.1 <- results_raw %>%
  select(-no_rarefy, -`P value category`) %>%
  pivot_longer(cols = paste("keep", c(100,95,90,85,80), sep = ""), 
               names_to = "keep_p", values_to = "pval") %>%
  group_by(`Gene stratum`, keep_p) %>%
  summarize(n_sig = sum(pval <= 0.05)) %>%
  ungroup() %>%
  mutate(keep_p = as.numeric(str_remove(keep_p,"keep"))) %>%
  ggplot(aes(x= keep_p, y = n_sig, color = `Gene stratum`)) +
  geom_point() + geom_line() + 
  xlab("Percentage of deep-sequence samples") + scale_x_reverse()+
  ylab("Number of findings, raw P") + 
  theme_bw() + scale_color_brewer(palette = "Set1")

results_adj <- as_tibble(results_adj) %>%
  dplyr::rename(keep100 = "discard = NULL; rarefy = TRUE",
                no_rarefy = "discard = NULL; rarefy = FALSE",
                keep95 = "discard = 0.05; rarefy = TRUE",
                keep90 = "discard = 0.10; rarefy = TRUE",
                keep85 = "discard = 0.15; rarefy = TRUE",
                keep80 = "discard = 0.20; rarefy = TRUE") %>%
  mutate(`P value category` = cut(keep100, breaks = c(-1, 0.001, 0.01, 0.05, 0.10, +Inf),
                                  labels = c("<= 0.001", "0.001 - 0.01", "0.01 - 0.05", 
                                             "0.05 - 0.10", "> 0.10")),
         `Gene stratum` = gene_stra) 
results_adj %>% 
  group_by(`P value category`, `Gene stratum`) %>% 
  slice_head(n = 1) %>%
  select(-no_rarefy) %>% 
  kbl(digits = 3, 
      caption = "Influence of discarding insufficiently sequenced samples in adjusted P values") %>% 
  kable_classic(full_width = F, html_font = "Cambria")
fig.2 <- results_adj %>%
  select(-no_rarefy, -`P value category`) %>%
  pivot_longer(cols = paste("keep", c(100,95,90,85,80), sep = ""), 
               names_to = "keep_p", values_to = "pval") %>%
  group_by(`Gene stratum`, keep_p) %>%
  summarize(n_sig = sum(pval <= 0.10)) %>%
  ungroup() %>%
  mutate(keep_p = as.numeric(str_remove(keep_p,"keep"))) %>%
  ggplot(aes(x= keep_p, y = n_sig, color = `Gene stratum`)) +
  geom_point() + geom_line() + 
  xlab("Percentage of deep-sequence samples") + scale_x_reverse()+
  ylab("Number of findings, adjusted P") + 
  theme_bw() + scale_color_brewer(palette = "Set1")

fig_discarding <- 
  lemon::grid_arrange_shared_legend(fig.1, fig.2, position = "right")
ggsave(filename = "results/discarding.jpeg", plot = fig_discarding,
       width = 8, height = 3)
ggsave(filename = "results/discarding.pdf", plot = fig_discarding,
       width = 8, height = 3)
```
